---
title: 'フィードバックサイクルを短くしよう'
description: '『レガシーコードからの脱却』から開発を高速化するヒント'
pubDate: '2023-09-23'
heroImage: 'driving_4256_2832.jpg'
draft: true
---

import Image from '../../components/Image.astro';
import Cite from '../../components/Cite.astro';
import OxDictCite from '../../components/OxDictCite.astro';

export const legacyCodeUrl =
  'https://www.amazon.co.jp/%25E3%2583%25AC%25E3%2582%25AC%25E3%2582%25B7%25E3%2583%25BC%25E3%2582%25B3%25E3%2583%25BC%25E3%2583%2589%25E3%2581%258B%25E3%2582%2589%25E3%2581%25AE%25E8%2584%25B1%25E5%258D%25B4-%25E2%2580%2595%25E3%2582%25BD%25E3%2583%2595%25E3%2583%2588%25E3%2582%25A6%25E3%2582%25A7%25E3%2582%25A2%25E3%2581%25AE%25E5%25AF%25BF%25E5%2591%25BD%25E3%2582%2592%25E5%25BB%25B6%25E3%2581%25B0%25E3%2581%2597%25E4%25BE%25A1%25E5%2580%25A4%25E3%2582%2592%25E9%25AB%2598%25E3%2582%2581%25E3%2582%258B9%25E3%2581%25A4%25E3%2581%25AE%25E3%2583%2597%25E3%2583%25A9%25E3%2582%25AF%25E3%2583%2586%25E3%2582%25A3%25E3%2582%25B9-David-Scott-Bernstein/dp/4873118867?&_encoding=UTF8&tag=michi1diver-22&linkCode=ur2&linkId=e758cbd1b5bf79b87aea809f655ddbc9&camp=247&creative=1211';

スムーズに開発を進められると気持ちいいですね。
スムーズに開発を進められるかどうかはフィードバックサイクルが大きく関係しています。

この記事では**コードの正しさを確認できる情報**を**フィードバック**、
フィードバックを確認する一連のプロセスを**フィードバックサイクル**と表現します。

書籍『レガシーコードからの脱却』では次のように述べられています。

> フィードバックサイクルの観点では、小さなバッチが望ましい。
> ソフトウェア開発におけるフィードバックサイクルの**ほとんどすべて**に当てはまる。
>
> <Cite
>   href={legacyCodeUrl}
>   text="レガシーコードからの脱却 - フィードバックサイクルを短くする"
> />

コードを書きながらリアルタイムにフィードバックが確認できる環境が理想です。
そのような環境では、間違ったコードを書いていてもすぐ気がついて修正できます。
フィードバックサイクルが短いほどスムーズな開発体験に貢献します。

そして、このような環境の実現にはビルド時間が大きく関係します。
再び『レガシーコードからの脱却』から引用します。

> 私が「ビルドを高速化しろ」という意図は、
> **3時間ではなく3秒以内に結果を返してくれるようなビルド環境を作れ**、ということだ。
>
> <Cite
>   href={legacyCodeUrl}
>   text="レガシーコードからの脱却 - ビルドを高速化する"
> />

今回の記事ではフィードバックサイクルとビルド時間のインパクトについて、
自分の考えや体験を書いていきます。

## フィードバックサイクルと開発効率

WEBのUI開発を題材としてフィードバックサイクルが開発効率に与える影響について考えてみます。
UI開発ではコードを変更してブラウザーで確認する、という作業の繰り返しです。
そのサイクルは次のような内訳です。

- 変更 : コードを変更して保存
- 待機 : 変更内容がブラウザーに反映されるまで待機
- 確認 : ブラウザーに反映された変更を確認

変更＋待機＋確認で1回の作業とします。待機の時間が1秒の環境と60秒の環境で1時間あたりの作業回数を計算します。

前提条件として1回の変更に60秒、その60秒の変更範囲をブラウザーで確認する時間が10秒だとして、
計算結果は次のとおりです。

| 待機時間 |  1時間(3600秒)あたりの<br/>作業回数  | 作業時間における<br/>待機時間の割合 |
| :------: | :----------------------------------: | :---------------------------------: |
|   1秒    | 3600 ÷ (60 + 1 + 10) = 約**50.7**回  |             約**1.5**%              |
|   60秒   | 3600 ÷ (60 + 60 + 10) = 約**27.7**回 |              約**46**%              |

開発効率は２倍ぐらい違います。
そうなりますよね、60秒待機が必要な環境では作業時間のほぼ半分は待機時間ですから。

実際に表示時間が60秒の開発環境では、きっとエンジニアは作業の進め方を「工夫」します。
どのような工夫かというとバッチを大きくすることで確認回数を減らします。
これは『レガシーコードからの脱却』の「小さなバッチが望ましい」というアドバイスを
無視することになりますね。

バッチを大きくすると待機時間を減らせるかもしれませんが、
無駄なコストや不要なリスクを発生させます。

変更範囲と作業時間の関係、変更範囲と結果の確認時間の関係は一次関数ではありません。
どのような関数になるか分かりませんが、指数関数や階乗のような曲線のはずです。

つまり変更範囲を広げれば、その作業や結果の確認により多くの時間を費やすことになります。
もちろん結果の確認に十分な時間を掛けないとバグのリスクを高めます。

このようなバッチの調整ではなく、高速なフィードバックを実現する開発環境の構築を目指しましょう。

## 多様なフィードバック

冒頭ではフィードバックを**コードの正しさを確認できる情報**と定義していました。
フィードバックの１つとしてブラウザーで確認する例を挙げましたが、
他のフィードバックとしては次のようなものがあります。

- エディターによるフィードバック
  - シンタックスハイライト
  - 型チェック
  - リントチェックと自動修正
- テストの実行結果
- 対話型実行環境によるフィードバック（Jupyter Notebookなど）
- ログ

これらのフィードバックをしっかり活用できる環境を作りましょう。
どれも自動でフィードバックされる環境が望ましいです。

エディター上で確認できる型チェックの結果やテストの実行結果は、
手動の動作確認よりも素早くフィードバックされます。
そういったフィードバックを活かすことでより少ない試行回数で正しいコードに着地できます。

## 最低限のマシンスペックは確保しよう

速さの追求は終わることがないですね。

- Webpack => Vite or Turbopack
- Nodejs => Deno => Bun

Viteを初めて触ったとき、速さに感動しました。
素晴らしい言語、ツールを開発してくださっている皆様に感謝です。

高速な技術を採用して、開発環境のフィードバックサイクルを短くすることは重要ですが、
より手っ取り早くシンプルに高速化する手段があります。

ちゃんとしたマシンを使いましょう。最低20万ぐらいはお金を掛けましょう。

ここでは私が経験した低スペックマシンによる最悪な開発体験を２つ紹介します。

### 15分待ちの動作確認

私のエンジニアとしての最初の仕事は2012年ごろ、まだ大学生でした。
仕事はAndroidアプリの開発で、
大学入学のタイミングで購入したメモリ1GBのノートパソコンでスタートしました。
まずAndroidのエミュレーターを起動して動作確認できるように環境を構築しました。
そしてEclipseの▷ボタンをクリックしてから15~20分ほど待つことが分かりました。

これはまずいと思い、2~3日で新しいメモリ8GBのノートパソコンを購入しました。
さらにエミュレーターではなく実機でデバックするようにしました。
すると▷ボタンをクリックして10秒程度で実機上で動作確認ができるようになりました。
自分のパソコンで仕事させてもらえる環境だったのですぐ問題が解決したのはラッキーでした。

### TypeScript の補完候補表示に3分待ち

2020年以降の開発にはメモリ8GBでも足りませんよ、という話です。

2022年、VSCode, TypeScript, Vite, Vue3, Volar(Vue3のVSCode拡張) といった技術で、
新規プロジェクトがスタートしました。

しかしいざ開発環境を整えてみるとエディターが非常に重たいのです。
私は会社支給のHPのメモリ8GBを搭載したノートPCを使用していましたが、
メモリの使用状況をみると8GBを使い切ってメモリ⇄SSDのスワップが発生していたのでしょう。

VSCode上にTypeScriptのエラーや補完候補を表示するのに3分以上、
ファイル保存前のESLint + Prettierの処理が3分以上という地獄のような開発環境でした。

1日の4時間以上はPCの処理待ちという状況だったと思います。
仕事が進まないということは自分のスキルも伸びないということです。
ずっと損している気持ちで仕事をしていて、とにかくしんどかったですね。

その後2023年から同じマシンで Nextjs の開発も経験しましたが、
TypeScriptのエラー・補完候補の表示は2〜10秒、ファイル保存前のESLint + Prettierの処理は2〜3秒でした。
Nextjsの開発体験と比較すると Vue3 の TypeScript対応はかなり難しかった（過去形？）ということが分かりますね。
とはいえ、十分なマシンスペックがあればTypeScriptの補完候補は3秒以内に表示されていたと思います。

個人開発で使用している2017年モデルの macbook pro (メモリ16GB)でも、VSCode, TypeScript, Vite, React の開発では
TypeScriptのエラー・補完候補の表示は瞬時、ファイル保存前のESLint + Prettierも瞬時です。

どれだけ最低限のマシンスペックが開発速度に影響するか、よく分かる経験でした。

## まとめ

フィードバックサイクルは、開発効率にとても大きな影響を与えます。
そのためフィードバックサイクルを短くするために時間を投資したとして
その時間を回収できる見込みはおそらく高いと思います。

以下を目指して開発環境を整えたいところです。

| フロントエンド    | バックエンド                |
| ----------------- | --------------------------- |
| 画面表示を1秒以内 | 単体テスト結果表示を3秒以内 |

この基準を達成できていないなら、
プロジェクトの全体の期間のうち20%程度を基準達成のために使った方がいいと思います。

あと、メモリ8GBのマシンを使っているなら16GBのマシンを買いましょう or 買ってもらいましょう。
